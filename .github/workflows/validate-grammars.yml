name: Validate Grammars

on:
  push:
    branches: [main]
    paths:
      - '**/*.ebnf'
      - '**/*.abnf'
      - 'formats/**/grammar.js'
      - '.github/workflows/validate-grammars.yml'
  pull_request:
    branches: [main]
    paths:
      - '**/*.ebnf'
      - '**/*.abnf'
      - 'formats/**/grammar.js'
      - '.github/workflows/validate-grammars.yml'
  workflow_dispatch:

jobs:
  validate-ebnf:
    name: Validate EBNF Grammars
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install EBNF validator
        run: pip install lark-parser

      - name: Validate EBNF syntax
        run: |
          cat > validate_ebnf.py << 'PYTHON'
          import sys
          import re
          from pathlib import Path

          def validate_ebnf(content, filename):
              """Basic EBNF syntax validation.
              Checks for rule definitions and basic structure."""
              errors = []
              lines = content.split('\n')

              has_rules = False
              for line in lines:
                  line = line.strip()
                  # Check for rule definition (name = ...)
                  if re.match(r'^[a-zA-Z_][a-zA-Z0-9_]*\s*=', line):
                      has_rules = True
                      break

              if not has_rules:
                  errors.append(f"{filename}: No rule definitions found")

              # Check file is not empty
              if not content.strip():
                  errors.append(f"{filename}: File is empty")

              return errors

          errors = []
          ebnf_files = list(Path('.').rglob('*.ebnf'))
          for ebnf_file in ebnf_files:
              content = ebnf_file.read_text()
              file_errors = validate_ebnf(content, str(ebnf_file))
              errors.extend(file_errors)

          if errors:
              for error in errors:
                  print(f"::error::{error}")
              sys.exit(1)
          else:
              print(f"All {len(ebnf_files)} EBNF files are syntactically valid")
          PYTHON
          python validate_ebnf.py

      - name: List EBNF files
        run: |
          echo "## EBNF Grammars" >> $GITHUB_STEP_SUMMARY
          for f in $(find . -name '*.ebnf' -type f | sort); do
            lines=$(wc -l < "$f")
            echo "- \`$f\` ($lines lines)" >> $GITHUB_STEP_SUMMARY
          done

  validate-abnf:
    name: Validate ABNF Grammars
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Validate ABNF syntax
        run: |
          # Basic ABNF validation - check for proper rule structure
          cat > validate_abnf.py << 'PYTHON'
          import sys
          import re
          from pathlib import Path

          def validate_abnf(content, filename):
              """Basic ABNF (RFC 5234) syntax validation.
              Checks for rule definitions and basic structure."""
              errors = []
              lines = content.split('\n')

              has_rules = False
              for line in lines:
                  line = line.strip()
                  # Skip comments
                  if line.startswith(';'):
                      continue
                  # Check for rule definition (rulename = ... or rulename =/ ...)
                  # ABNF rule names are case-insensitive alphanumeric
                  if re.match(r'^[a-zA-Z][a-zA-Z0-9-]*\s*=', line):
                      has_rules = True
                      break

              if not has_rules:
                  errors.append(f"{filename}: No rule definitions found")

              # Check file is not empty
              if not content.strip():
                  errors.append(f"{filename}: File is empty")

              return errors

          errors = []
          abnf_files = list(Path('.').rglob('*.abnf'))
          for abnf_file in abnf_files:
              content = abnf_file.read_text()
              file_errors = validate_abnf(content, str(abnf_file))
              errors.extend(file_errors)

          if errors:
              for error in errors:
                  print(f"::error::{error}")
              sys.exit(1)
          else:
              print(f"All {len(abnf_files)} ABNF files are syntactically valid")
          PYTHON
          python validate_abnf.py

      - name: List ABNF files
        run: |
          echo "## ABNF Grammars" >> $GITHUB_STEP_SUMMARY
          for f in $(find . -name '*.abnf' -type f | sort); do
            lines=$(wc -l < "$f")
            echo "- \`$f\` ($lines lines)" >> $GITHUB_STEP_SUMMARY
          done

  validate-tree-sitter:
    name: Validate Tree-sitter Grammars
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install tree-sitter CLI
        run: npm install -g tree-sitter-cli

      - name: Validate grammar.js files
        run: |
          for ts_dir in $(find . -type d -name 'tree-sitter'); do
            if [[ -f "$ts_dir/grammar.js" ]]; then
              echo "Validating: $ts_dir/grammar.js"
              cd "$ts_dir"
              # Check if package.json exists and has valid syntax
              if [[ -f package.json ]] && [[ -s package.json ]]; then
                npm install 2>/dev/null || true
                tree-sitter generate || echo "::warning file=$ts_dir/grammar.js::Tree-sitter generate failed"
              else
                # Just validate the JS syntax
                node -c grammar.js || echo "::warning file=$ts_dir/grammar.js::JavaScript syntax error"
              fi
              cd - > /dev/null
            fi
          done

      - name: Summary
        run: |
          echo "## Tree-sitter Grammars" >> $GITHUB_STEP_SUMMARY
          for f in $(find . -path '*/tree-sitter/grammar.js' -type f | sort); do
            echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY
          done
