name: Benchmarks

on:
  push:
    branches: [main]
    paths:
      - 'conformance/benchmarks/**'
      - '.github/workflows/benchmarks.yml'
  pull_request:
    branches: [main]
    paths:
      - 'conformance/benchmarks/**'
  schedule:
    # Run weekly on Sunday at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      implementations:
        description: 'Implementations to benchmark (comma-separated)'
        default: 'beancount'
        type: string

jobs:
  generate-benchmarks:
    name: Generate Benchmark Files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate benchmark files
        run: |
          cd conformance/benchmarks
          mkdir -p files

          # Generate all sizes
          python generate-benchmark.py --preset small --output files/small.beancount
          python generate-benchmark.py --preset medium --output files/medium.beancount
          python generate-benchmark.py --preset large --output files/large.beancount

      - name: Upload benchmark files
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-files
          path: conformance/benchmarks/files/

  benchmark-beancount:
    name: Benchmark Beancount
    runs-on: ubuntu-latest
    needs: generate-benchmarks

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install beancount
        run: pip install beancount

      - name: Download benchmark files
        uses: actions/download-artifact@v4
        with:
          name: benchmark-files
          path: conformance/benchmarks/files/

      - name: Run benchmarks
        run: |
          cd conformance/benchmarks/files

          echo "=== Small (100 transactions) ==="
          time bean-check small.beancount

          echo ""
          echo "=== Medium (10,000 transactions) ==="
          time bean-check medium.beancount

          echo ""
          echo "=== Large (100,000 transactions) ==="
          time bean-check large.beancount

      - name: Detailed timing
        run: |
          cd conformance/benchmarks/files

          # Multiple runs for consistency
          echo "Running 5 iterations on medium file..."
          for i in 1 2 3 4 5; do
            /usr/bin/time -f "%e seconds" bean-check medium.beancount 2>&1 | tail -1
          done

  benchmark-comparison:
    name: Compare Implementations
    runs-on: ubuntu-latest
    needs: generate-benchmarks
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install beancount
        run: pip install beancount

      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Download benchmark files
        uses: actions/download-artifact@v4
        with:
          name: benchmark-files
          path: conformance/benchmarks/files/

      - name: Run comparison benchmarks
        run: |
          cd conformance/benchmarks/files

          echo "=== Benchmark: Medium file ==="
          hyperfine \
            --warmup 3 \
            --min-runs 10 \
            --export-json benchmark-results.json \
            "bean-check medium.beancount"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: conformance/benchmarks/files/benchmark-results.json
