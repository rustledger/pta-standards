(* CSV Import Rules EBNF Grammar *)
(* ISO/IEC 14977 Extended BNF notation *)
(*
 * This grammar defines a generic CSV import rules format
 * compatible with hledger-style rules but format-agnostic.
 *
 * Notation:
 *   =     definition
 *   ,     concatenation
 *   |     alternation
 *   [ ]   optional (0 or 1)
 *   { }   repetition (0 or more)
 *   { }- repetition (1 or more)
 *   (* *) comment
 *   " "   terminal string
 *)

(* =========================================================================== *)
(* TOP LEVEL                                                                   *)
(* =========================================================================== *)

rules_file = { line, NEWLINE }, [ line ] ;

line = rule_directive
     | conditional_block
     | comment_line
     | empty_line ;

empty_line = { WHITESPACE } ;

comment_line = [ { WHITESPACE } ], ( ";" | "#" ), { ANY - NEWLINE } ;

(* =========================================================================== *)
(* RULE DIRECTIVES                                                             *)
(* =========================================================================== *)

rule_directive = source_directive
               | field_directive
               | format_directive
               | account_directive
               | transform_directive
               | include_directive ;

(* --------------------------------------------------------------------------- *)
(* Source Directives                                                           *)
(* --------------------------------------------------------------------------- *)

source_directive = skip_directive
                 | separator_directive
                 | encoding_directive
                 | source_pattern_directive ;

skip_directive = "skip", { WHITESPACE }, skip_value ;

skip_value = integer | "end" ;

separator_directive = "separator", { WHITESPACE }, separator_value ;

separator_value = quoted_char | unquoted_char ;

quoted_char = '"', ANY, '"'
            | "'", ANY, "'" ;

unquoted_char = ANY - ( WHITESPACE | NEWLINE ) ;

encoding_directive = "encoding", { WHITESPACE }, encoding_name ;

encoding_name = "utf-8" | "utf-16" | "latin1" | "iso-8859-1"
              | identifier ;

source_pattern_directive = "source", { WHITESPACE }, glob_pattern ;

glob_pattern = { ANY - NEWLINE }- ;

(* --------------------------------------------------------------------------- *)
(* Field Directives                                                            *)
(* --------------------------------------------------------------------------- *)

field_directive = "fields", { WHITESPACE }, field_list
                | field_assignment ;

field_list = field_name, { { WHITESPACE }, ",", { WHITESPACE }, field_name } ;

field_name = standard_field | custom_field ;

standard_field = "date" | "date2" | "status" | "code"
               | "description" | "payee" | "narration"
               | "account1" | "account2"
               | "amount" | "amount-in" | "amount-out"
               | "currency" | "balance" | "comment" ;

custom_field = identifier ;

field_assignment = field_name, { WHITESPACE }, field_value ;

field_value = value_template ;

value_template = { template_element }- ;

template_element = literal_text
                 | variable_reference
                 | transformation ;

literal_text = { ANY - ( "%" | "{" | NEWLINE ) }- ;

variable_reference = "%", ( field_name | column_number )
                   | "%", "(", expression, ")"
                   | "{", variable_name, "}" ;

column_number = integer ;

expression = { ANY - ")" }- ;

variable_name = identifier ;

transformation = variable_reference, transform_chain ;

transform_chain = { transform_op }- ;

transform_op = "|", transform_name, [ "(", transform_args, ")" ] ;

transform_name = "upper" | "lower" | "trim" | "strip"
               | "replace" | "regex" | "default"
               | identifier ;

transform_args = { ANY - ")" }- ;

(* --------------------------------------------------------------------------- *)
(* Format Directives                                                           *)
(* --------------------------------------------------------------------------- *)

format_directive = date_format_directive
                 | decimal_mark_directive
                 | currency_directive
                 | newest_first_directive ;

date_format_directive = "date-format", { WHITESPACE }, date_format_spec ;

date_format_spec = { format_specifier | literal_char }- ;

format_specifier = "%", format_code ;

format_code = "Y" | "y" | "m" | "d" | "B" | "b" | "e"
            | "H" | "M" | "S" | "p" | "%" ;

literal_char = ANY - ( "%" | NEWLINE ) ;

decimal_mark_directive = "decimal-mark", { WHITESPACE }, decimal_char ;

decimal_char = "." | "," ;

currency_directive = "currency", { WHITESPACE }, currency_symbol ;

currency_symbol = { ANY - ( WHITESPACE | NEWLINE ) }- ;

newest_first_directive = "newest-first" ;

(* --------------------------------------------------------------------------- *)
(* Account Directives                                                          *)
(* --------------------------------------------------------------------------- *)

account_directive = account_assignment ;

account_assignment = ( "account1" | "account2" ), { WHITESPACE }, account_value ;

account_value = value_template ;

(* --------------------------------------------------------------------------- *)
(* Transform Directives                                                        *)
(* --------------------------------------------------------------------------- *)

transform_directive = "amount-type", { WHITESPACE }, amount_type_value
                    | "sign-flip"
                    | "negate-amount" ;

amount_type_value = "combined" | "separate" | "debit-credit" ;

(* --------------------------------------------------------------------------- *)
(* Include Directives                                                          *)
(* --------------------------------------------------------------------------- *)

include_directive = "include", { WHITESPACE }, file_path ;

file_path = { ANY - NEWLINE }- ;

(* =========================================================================== *)
(* CONDITIONAL BLOCKS                                                          *)
(* =========================================================================== *)

conditional_block = if_clause, { conditional_rule } ;

if_clause = "if", { WHITESPACE }, condition, [ trailing_comment ], NEWLINE
          | "if", NEWLINE, { condition_line, NEWLINE } ;

condition_line = { WHITESPACE }, condition ;

condition = regex_condition
          | field_condition
          | amount_condition
          | combined_condition ;

regex_condition = [ "!" ], "/", regex_pattern, "/" ;

regex_pattern = { regex_char }- ;

regex_char = ANY - ( "/" | NEWLINE )
           | "\/" ;

field_condition = [ "!" ], field_name, comparison_op, comparison_value ;

comparison_op = "=" | "==" | "!=" | "<" | "<=" | ">" | ">="
              | "=~" | "!~" | "~" ;

comparison_value = { ANY - NEWLINE }- ;

amount_condition = [ "!" ], "amount", amount_test ;

amount_test = comparison_op, number
            | "positive" | "negative" | "zero" ;

combined_condition = condition, { ( "and" | "or" | "&" | "|" ), condition } ;

conditional_rule = WHITESPACE, { WHITESPACE }, rule_directive, [ trailing_comment ] ;

(* =========================================================================== *)
(* PRIMITIVES                                                                  *)
(* =========================================================================== *)

identifier = letter, { letter | digit | "-" | "_" } ;

letter = ASCII_ALPHA ;

integer = digit, { digit } ;

number = [ "-" ], integer, [ ".", { digit }- ] ;

(* =========================================================================== *)
(* CHARACTER CLASSES                                                           *)
(* =========================================================================== *)

trailing_comment = { WHITESPACE }, ( ";" | "#" ), { ANY - NEWLINE } ;

WHITESPACE = " " | "\t" ;

NEWLINE = "\r\n" | "\n" | "\r" ;

ANY = ? any Unicode character ? ;

digit = "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" ;

ASCII_ALPHA = "A" | "B" | "C" | "D" | "E" | "F" | "G" | "H" | "I" | "J"
            | "K" | "L" | "M" | "N" | "O" | "P" | "Q" | "R" | "S" | "T"
            | "U" | "V" | "W" | "X" | "Y" | "Z"
            | "a" | "b" | "c" | "d" | "e" | "f" | "g" | "h" | "i" | "j"
            | "k" | "l" | "m" | "n" | "o" | "p" | "q" | "r" | "s" | "t"
            | "u" | "v" | "w" | "x" | "y" | "z" ;
